<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Management System</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Load Firebase Modules -->
    <script type="module">
        // Import necessary Firebase functions
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, addDoc, onSnapshot, getDoc, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the Canvas environment (with robust safety check)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        // Safety check for configuration
        let firebaseConfig = {};
        let initialAuthToken = null;
        const hasFirebaseConfig = typeof __firebase_config !== 'undefined' && __firebase_config && __firebase_config.trim() !== '{}';

        if (hasFirebaseConfig) {
             try {
                firebaseConfig = JSON.parse(__firebase_config);
                initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
             } catch (e) {
                 console.error("Failed to parse Firebase configuration string:", e);
             }
        }
        
        // Global application state variables
        let dbInstance = null;
        let authInstance = null;
        let userId = null;
        let userProfile = { name: 'Local User', role: 'Employee', managerId: 'manager-1' };
        let isAuthReady = false;
        
        // --- Firestore Collection Paths ---
        const USER_PROFILES_COLLECTION = (uid) => `artifacts/${appId}/users/${uid}/profiles`;
        const EXPENSES_COLLECTION = `artifacts/${appId}/public/data/expenses`;

        // --- Core Authentication and Setup ---
        window.initApp = async () => {
            const spinner = document.getElementById('loading-spinner');
            const contentArea = document.getElementById('content-area');
            spinner.classList.remove('hidden');
            spinner.classList.add('flex', 'items-center', 'justify-center');

            try {
                // --- CRITICAL SAFETY CHECK ADDED HERE ---
                if (!hasFirebaseConfig || Object.keys(firebaseConfig).length === 0 || !firebaseConfig.projectId) {
                    console.warn("Missing Firebase configuration. Running in Local Mock Mode (no real-time persistence or saving).");
                    
                    // Set mock ready state and skip all Firebase calls
                    userId = 'mock-user-' + Math.random().toString(36).substring(2, 8);
                    window.db = null; // Important: Null the DB instance
                    window.getUserId = () => userId;
                    window.getUserRole = () => userProfile.role;
                    window.isAuthReady = () => true; 
                    window.allExpenses = []; // Empty mock expense array
                    window.demoUsers = {
                        [userId]: userProfile,
                        'manager-1': { name: 'Local Manager', role: 'Manager', managerId: null, uid: 'manager-1' }
                    };
                    
                    // Expose mock utilities to prevent errors, but they won't save data
                    window.collection = (db, path) => ({ db, path }); 
                    window.addDoc = async () => { 
                        window.showModal('Local Mode Alert', 'Cannot save expense. Application is running in local mode without Firebase configuration.');
                        return { id: 'mock-id' };
                    };
                    window.updateDoc = async () => console.log('Mock update called.');
                    window.doc = () => {}; 
                    window.EXPENSES_COLLECTION = 'mock-collection';
                    window.startExpenseListener = () => { window.calculateBaseAmounts(); }; 

                    // Update UI immediately
                    window.setupApplication();
                    return; 
                }
                // --- END OF CRITICAL SAFETY CHECK ---

                // 1. Initialize Firebase (Only runs if config is present)
                const app = initializeApp(firebaseConfig);
                dbInstance = getFirestore(app);
                authInstance = getAuth(app);
                
                setLogLevel('Debug'); 
                
                // 2. Authentication
                if (initialAuthToken) {
                    await signInWithCustomToken(authInstance, initialAuthToken);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(authInstance);
                    console.log("Signed in anonymously.");
                }
                
                // 3. Auth State Listener
                onAuthStateChanged(authInstance, async (user) => {
                    if (user) {
                        userId = user.uid;
                        await fetchOrCreateUserProfile(userId);
                        
                        // 4. Expose all necessary resources to the global window object
                        window.db = dbInstance; 
                        window.auth = authInstance;
                        window.getUserId = () => userId;
                        window.getUserRole = () => userProfile.role;
                        window.isAuthReady = () => isAuthReady;
                        
                        // Expose Firestore utility functions and collection constant
                        window.collection = collection;
                        window.doc = doc;
                        window.addDoc = addDoc;
                        window.updateDoc = updateDoc;
                        window.getDoc = getDoc;
                        window.EXPENSES_COLLECTION = EXPENSES_COLLECTION;

                        // Call the main setup function in the global script
                        window.setupApplication();
                    } 
                });

            } catch (error) {
                console.error("Firebase Initialization or Auth Error:", error);
                // If Firebase init fails, fall back to showing the content with an error message.
                window.showModal('Fatal Error', 'Failed to initialize Firebase and authenticate. The application will not save data. Check console for details.');
                
                // Show content anyway
                spinner.classList.add('hidden');
                spinner.classList.remove('flex', 'items-center', 'justify-center');
                contentArea.classList.remove('hidden');
            }
        };

        // --- User Profile Management ---
        const fetchOrCreateUserProfile = async (uid) => {
            if (!dbInstance) return;

            const profileRef = doc(dbInstance, USER_PROFILES_COLLECTION(uid), 'profile');
            const profileSnap = await getDoc(profileRef);

            if (profileSnap.exists()) {
                userProfile = profileSnap.data();
                console.log("Profile loaded:", userProfile);
            } else {
                const shortUid = uid.substring(uid.length - 4);
                userProfile = {
                    name: `User ${shortUid}`,
                    role: 'Employee',
                    managerId: 'admin-manager-default', 
                    uid: uid
                };
                setDoc(profileRef, userProfile).catch(e => console.error("Error setting default profile:", e));
                console.log("Default profile created:", userProfile);
            }
            
            window.demoUsers = {
                [uid]: userProfile,
                'admin-manager-default': { name: 'Default Manager', role: 'Manager', managerId: null, uid: 'admin-manager-default' }
            };
            
            isAuthReady = true;
        };


        // --- Firestore Real-time Listener (New Logic) ---
        window.startExpenseListener = () => {
            if (!window.db) {
                // If running in local mode, just calculate and render static content
                window.calculateBaseAmounts();
                return;
            }

            const expensesRef = collection(window.db, window.EXPENSES_COLLECTION);
            
            onSnapshot(expensesRef, (snapshot) => {
                window.allExpenses = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                console.log(`Fetched ${window.allExpenses.length} expenses in real-time.`);
                window.calculateBaseAmounts(); 
                
            }, (error) => {
                console.error("Error fetching real-time expenses:", error);
                window.showModal('Error', 'Failed to subscribe to real-time expense data.');
                
                // If there's an error, still show the UI
                const spinner = document.getElementById('loading-spinner');
                spinner.classList.add('hidden');
                spinner.classList.remove('flex', 'items-center', 'justify-center');
                document.getElementById('content-area').classList.remove('hidden');
            });
        };


        // --- Global Setup Mappings ---
        window.companyBaseCurrency = 'USD';
        window.allExpenses = [];
        window.demoUsers = {}; 

        
        // --- Initial setup function called on window load ---
        window.addEventListener('load', () => {
             // We always call initApp now, and the function handles the Firebase check internally
             window.initApp();
        });
        
    </script>
    <style>
        :root {
            --primary-color: #008a00; /* Odoo Green */
            --secondary-color: #00b466; 
            --text-color: #333;
        }
        body {
            font-family: 'Inter', sans-serif;
            color: var(--text-color);
            background-color: #f8f9fa;
        }
        .header-bg {
            background-color: var(--primary-color);
        }
        .text-odoo-green {
            color: var(--primary-color);
        }
        .bg-odoo-green {
            background-color: var(--primary-color);
        }
        .btn-primary {
            background-color: var(--primary-color);
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #007700;
        }
        .status-pill {
            padding: 4px 8px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-Pending {
            background-color: #ffedd5;
            color: #9a3412;
        }
        .status-Approved {
            background-color: #d1fae5;
            color: #065f46;
        }
        .status-Rejected {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .status-Draft {
            background-color: #e0f2fe;
            color: #0c4a6e;
        }
        /* Custom scrollbar for tables */
        .custom-scroll::-webkit-scrollbar {
            height: 6px;
        }
        .custom-scroll::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="header-bg text-white shadow-lg p-4 md:p-6 flex justify-between items-center">
            <h1 class="text-xl md:text-2xl font-bold">Odoo Expense Manager</h1>
            <div class="flex items-center space-x-4">
                <div id="user-info" class="text-sm md:text-base font-medium">Loading User...</div>
                <p id="user-id-display" class="text-xs font-mono bg-white text-gray-800 p-1 rounded-md">ID: ...</p>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="flex-grow p-4 md:p-8">
            <div id="loading-spinner" class="text-center py-12 flex items-center justify-center">
                <svg class="animate-spin h-8 w-8 text-odoo-green mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-2 text-gray-600">Connecting to database and fetching expenses...</p>
            </div>

            <div id="content-area" class="space-y-10 hidden">
                <!-- Tabs for main navigation -->
                <div class="flex border-b border-gray-200">
                    <button class="tab-button px-4 py-2 text-sm md:text-base font-medium border-b-2 border-transparent transition duration-150 ease-in-out" data-tab="dashboard">My Expenses</button>
                    <button class="tab-button px-4 py-2 text-sm md:text-base font-medium border-b-2 border-transparent transition duration-150 ease-in-out" data-tab="submission">Submit Expense</button>
                    <button class="tab-button px-4 py-2 text-sm md:text-base font-medium border-b-2 border-transparent transition duration-150 ease-in-out" data-tab="manager" id="manager-tab" style="display:none;">Approvals</button>
                    <button class="tab-button px-4 py-2 text-sm md:text-base font-medium border-b-2 border-transparent transition duration-150 ease-in-out" data-tab="admin" id="admin-tab" style="display:none;">Admin Config</button>
                </div>

                <!-- Tab Content -->
                <div id="tab-content" class="space-y-6">
                    <div id="dashboard" class="tab-pane">
                        <h2 class="text-2xl font-semibold mb-4 text-odoo-green">My Expense History</h2>
                        <div class="bg-white p-4 md:p-6 rounded-xl shadow-md overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="employee-expense-list" class="bg-white divide-y divide-gray-200">
                                    <!-- Employee expense rows go here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="submission" class="tab-pane hidden">
                        <h2 class="text-2xl font-semibold mb-6 text-odoo-green">Submit New Expense Claim</h2>
                        <div class="max-w-xl bg-white p-6 md:p-8 rounded-xl shadow-md">
                            <form id="expense-form" onsubmit="window.submitExpense(event)">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="exp-date" class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                                        <input type="date" id="exp-date" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-odoo-green focus:border-odoo-green">
                                    </div>
                                    <div>
                                        <label for="exp-category" class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                                        <select id="exp-category" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-odoo-green focus:border-odoo-green">
                                            <option value="">Select Category</option>
                                            <option value="Meals">Meals</option>
                                            <option value="Travel">Travel</option>
                                            <option value="Accommodation">Accommodation</option>
                                            <option value="Software">Software/Subscriptions</option>
                                            <option value="Other">Other</option>
                                        </select>
                                    </div>
                                    <div class="col-span-1 md:col-span-2">
                                        <label for="exp-description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                                        <textarea id="exp-description" rows="3" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-odoo-green focus:border-odoo-green"></textarea>
                                    </div>
                                    <div class="col-span-1 md:col-span-2 flex space-x-4">
                                        <div class="flex-1">
                                            <label for="exp-amount" class="block text-sm font-medium text-gray-700 mb-1">Amount</label>
                                            <input type="number" id="exp-amount" step="0.01" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-odoo-green focus:border-odoo-green">
                                        </div>
                                        <div class="w-24">
                                            <label for="exp-currency" class="block text-sm font-medium text-gray-700 mb-1">Currency</label>
                                            <select id="exp-currency" required class="w-full p-2 border border-gray-300 rounded-lg focus:ring-odoo-green focus:border-odoo-green">
                                                <option value="USD">USD</option>
                                                <option value="EUR">EUR</option>
                                                <option value="GBP">GBP</option>
                                                <option value="INR">INR</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn-primary text-white font-semibold py-2 px-4 rounded-lg mt-8 w-full shadow-md hover:shadow-lg flex items-center justify-center" id="submit-button">
                                    <span id="submit-text">Submit Claim</span>
                                    <span id="submit-spinner" class="hidden animate-spin h-5 w-5 ml-2 border-t-2 border-r-2 border-white rounded-full"></span>
                                </button>
                            </form>
                        </div>
                    </div>

                    <div id="manager" class="tab-pane hidden">
                        <h2 class="text-2xl font-semibold mb-4 text-odoo-green">Expenses Awaiting My Approval</h2>
                        <p class="text-sm text-gray-600 mb-4">All amounts are displayed in the company's base currency: **USD**. (Note: Rates are currently fixed at 1:1 for reliable submission.)</p>
                        <div class="bg-white p-4 md:p-6 rounded-xl shadow-md overflow-x-auto custom-scroll">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Submitted By</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Amount (USD)</th>
                                        <th class="px-3 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Original Amount</th>
                                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="manager-approval-list" class="bg-white divide-y divide-gray-200">
                                    <!-- Manager approval rows go here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="admin" class="tab-pane hidden">
                        <h2 class="text-2xl font-semibold mb-6 text-odoo-green">Admin Configuration</h2>
                        <div class="grid grid-cols-1 md:col-cols-2 gap-8">
                            <!-- User Management Card -->
                            <div class="bg-white p-6 rounded-xl shadow-md">
                                <h3 class="text-xl font-semibold mb-4 flex items-center"><i data-lucide="users" class="w-5 h-5 mr-2 text-odoo-green"></i> User Roles</h3>
                                <div id="admin-user-list" class="space-y-3">
                                    <p class="text-gray-600">User management is simplified to the currently logged in user for the hackathon environment.</p>
                                    <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                        <div>
                                            <p class="font-medium" id="admin-current-user-name">...</p>
                                            <p class="text-xs text-odoo-green font-semibold" id="admin-current-user-role">...</p>
                                            <p class="text-xs text-gray-500">Manager: Default Manager (admin-manager-default)</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Flow Management Card -->
                            <div class="bg-white p-6 rounded-xl shadow-md">
                                <h3 class="text-xl font-semibold mb-4 flex items-center"><i data-lucide="git-branch" class="w-5 h-5 mr-2 text-odoo-green"></i> Approval Flows</h3>
                                <p class="text-gray-600">The current approval flow is a single-step: Employee -> Manager (Default).</p>
                                <button class="btn-primary text-white font-semibold py-2 px-4 rounded-lg mt-4 shadow-md text-sm cursor-not-allowed opacity-50">Create New Flow (Disabled)</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- Custom Modal for Notifications -->
        <div id="custom-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center p-4 z-50" onclick="this.classList.add('hidden')">
            <div class="bg-white rounded-xl p-6 shadow-2xl max-w-sm w-full" onclick="event.stopPropagation()">
                <h3 id="modal-title" class="text-xl font-bold mb-3 text-odoo-green">Notification</h3>
                <p id="modal-message" class="text-gray-700 mb-4"></p>
                <button onclick="document.getElementById('custom-modal').classList.add('hidden')" class="btn-primary text-white font-semibold py-2 px-4 rounded-lg w-full">OK</button>
            </div>
        </div>

    </div>

    <script>
        // --- Core Application Logic ---
        
        let userProfilesMap = {}; 
        let currentUserId = null;
        let userProfile = {};
        
        // Helper function to show custom modal (replaces alert/confirm)
        window.showModal = (title, message) => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('custom-modal').classList.remove('hidden');
            document.getElementById('custom-modal').classList.add('flex');
        };

        // Function to update the UI based on the current user's profile
        const updateUI = () => {
            currentUserId = window.getUserId(); 
            userProfile = window.demoUsers[currentUserId]; 
            
            if (!userProfile) {
                console.warn("User profile not ready during UI update, skipping.");
                return;
            }

            userProfilesMap = {
                ...window.demoUsers 
            };

            // 1. Update Header Info
            document.getElementById('user-info').textContent = `${userProfile.name} (${userProfile.role})`;
            
            // Check if Firebase is active before trying to show full UID
            if (window.db) {
                document.getElementById('user-id-display').textContent = `ID: ${currentUserId.substring(0, 8)}...`;
            } else {
                 document.getElementById('user-id-display').textContent = `ID: LOCAL`;
            }
            
            // 2. Hide/Show Role-Specific Tabs
            const managerTab = document.getElementById('manager-tab');
            const adminTab = document.getElementById('admin-tab');
            const role = userProfile.role;
            
            managerTab.style.display = (role === 'Manager' || role === 'Admin') ? 'block' : 'none';
            adminTab.style.display = (role === 'Admin') ? 'block' : 'none';

            // 3. Render Content
            renderContent();

            // 4. Activate Dashboard tab and icons
            const dashboardButton = document.querySelector('.tab-button[data-tab="dashboard"]');
            if (dashboardButton && !dashboardButton.classList.contains('border-odoo-green')) {
                dashboardButton.click();
            }
            lucide.createIcons();
        };

        // Function to render the content for the current role
        const renderContent = () => {
            renderEmployeeDashboard();
            if (userProfile.role === 'Manager' || userProfile.role === 'Admin') {
                renderManagerApprovals();
            }
            if (userProfile.role === 'Admin') {
                renderAdminConfig();
            }
        };

        // --- Currency Conversion (MOCKED FOR STABILITY) ---

        /**
         * Calculates and sets the base_amount for all expenses using a fixed rate (1.0).
         */
        window.calculateBaseAmounts = () => {
            // Update all expenses with calculated base_amount (fixed at 1:1 conversion for stability)
            window.allExpenses = window.allExpenses.map(expense => {
                expense.base_amount = expense.original_amount; 
                return expense;
            });

            // Hide spinner and show content only after the first data load + conversion
            const spinner = document.getElementById('loading-spinner');
            const contentArea = document.getElementById('content-area');
            if(spinner.classList.contains('flex') || spinner.classList.contains('animate-spin')){
                 spinner.classList.add('hidden');
                 spinner.classList.remove('flex', 'items-center', 'justify-center');
                 contentArea.classList.remove('hidden');
            }
            
            updateUI();
        };

        // --- Render Functions ---

        const renderEmployeeDashboard = () => {
            const listEl = document.getElementById('employee-expense-list');
            listEl.innerHTML = '';
            
            const userExpenses = window.allExpenses.filter(e => e.userId === currentUserId)
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            if (userExpenses.length === 0) {
                listEl.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">No expenses submitted yet.</td></tr>`;
                return;
            }

            userExpenses.forEach(expense => {
                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-700">${expense.date}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-800">${expense.description}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500">${expense.category}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-right font-semibold">
                            ${expense.original_amount.toFixed(2)} ${expense.original_currency}
                        </td>
                        <td class="px-3 py-3 whitespace-nowrap text-center">
                            <span class="status-pill status-${expense.status}">
                                ${expense.status}
                            </span>
                        </td>
                    </tr>
                `;
                listEl.innerHTML += row;
            });
        };

        const renderManagerApprovals = () => {
            const listEl = document.getElementById('manager-approval-list');
            listEl.innerHTML = '';
            const managerId = currentUserId; 

            const expensesForApproval = window.allExpenses.filter(e => 
                e.status === 'Pending' && e.approverId === managerId
            ).sort((a, b) => new Date(a.date) - new Date(b.date));

            if (expensesForApproval.length === 0) {
                listEl.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">No expenses awaiting your approval.</td></tr>`;
                return;
            }

            expensesForApproval.forEach(expense => {
                const userName = userProfilesMap[expense.userId]?.name || 'Unknown User';
                const row = `
                    <tr class="hover:bg-gray-50">
                        <td class="px-3 py-3 whitespace-nowrap text-sm font-medium text-gray-800">${userName}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-700">${expense.date}</td>
                        <td class="px-3 py-3 whitespace-normal max-w-xs text-sm text-gray-500">${expense.description}</td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm font-semibold text-right text-odoo-green">
                            $${expense.base_amount.toFixed(2)}
                        </td>
                        <td class="px-3 py-3 whitespace-nowrap text-sm text-gray-500 text-right">
                            (${expense.original_amount.toFixed(2)} ${expense.original_currency})
                        </td>
                        <td class="px-3 py-3 whitespace-nowrap text-center space-x-2">
                            <button onclick="window.handleApproval('${expense.id}', 'Approved', event)" 
                                class="bg-green-500 hover:bg-green-600 text-white p-2 rounded-lg text-xs font-semibold shadow-sm">
                                Approve
                            </button>
                            <button onclick="window.handleApproval('${expense.id}', 'Rejected', event)" 
                                class="bg-red-500 hover:bg-red-600 text-white p-2 rounded-lg text-xs font-semibold shadow-sm">
                                Reject
                            </button>
                        </td>
                    </tr>
                `;
                listEl.innerHTML += row;
            });
        };

        const renderAdminConfig = () => {
            document.getElementById('admin-current-user-name').textContent = `${userProfile.name} (${currentUserId.substring(0, 8)}...)`;
            document.getElementById('admin-current-user-role').textContent = userProfile.role;
            lucide.createIcons();
        };

        // --- Data Write Handlers ---

        window.submitExpense = async (event) => {
            event.preventDefault();

            // Check if we are ready
            if (!window.isAuthReady()) {
                window.showModal('Initialization Error', 'Application is still connecting to the database. Please wait a moment and try again.');
                return;
            }

            const submitBtn = document.getElementById('submit-button');
            const submitText = document.getElementById('submit-text');
            const submitSpinner = document.getElementById('submit-spinner');

            submitText.textContent = 'Processing...';
            submitSpinner.classList.remove('hidden');
            submitBtn.disabled = true;

            const original_currency = document.getElementById('exp-currency').value;
            const original_amount = parseFloat(document.getElementById('exp-amount').value);
            
            try {
                // MOCK: Base amount is set to original amount (1:1 conversion) to avoid API dependency
                const base_amount = original_amount; 

                // Construct the new expense object
                const newExpenseData = {
                    userId: currentUserId,
                    userName: userProfile.name,
                    date: document.getElementById('exp-date').value,
                    description: document.getElementById('exp-description').value,
                    category: document.getElementById('exp-category').value,
                    original_amount: original_amount,
                    original_currency: original_currency,
                    base_amount: base_amount,
                    status: 'Pending', 
                    approverId: userProfile.managerId || 'admin-manager-default', 
                    submitted_on: new Date().toISOString()
                };

                if (window.db) {
                    // Real-time submission
                    const expensesCollectionRef = window.collection(window.db, window.EXPENSES_COLLECTION);
                    await window.addDoc(expensesCollectionRef, newExpenseData);
                    window.showModal('Success!', `Expense claim submitted successfully for approval. Value: $${base_amount.toFixed(2)} USD.`);
                } else {
                    // Local Mock Mode: Add to the local array and reset form
                    window.allExpenses.push({ ...newExpenseData, id: 'mock-' + window.allExpenses.length });
                    renderContent(); // Rerender to show the new expense in the table
                    window.showModal('Success (Local Mode)!', `Expense claim submitted to local history. It was NOT saved to the database.`);
                }
                
                // Update UI and provide feedback
                document.getElementById('expense-form').reset();
            } catch (e) {
                console.error("Error submitting expense:", e);
                window.showModal('Submission Failed', `An error occurred: ${e.message}. Please check console for network errors.`);
            } finally {
                submitText.textContent = 'Submit Claim';
                submitSpinner.classList.add('hidden');
                submitBtn.disabled = false;
            }
        };

        window.handleApproval = async (expenseId, newStatus, event) => {
            if (!window.isAuthReady()) {
                window.showModal('Initialization Error', 'Application is still connecting to the database. Please wait a moment and try again.');
                return;
            }
            
             const approvalBtn = event.target;
             approvalBtn.disabled = true;
             approvalBtn.textContent = '...';

            try {
                if (window.db) {
                    // Real-time update
                    const expenseDocRef = window.doc(window.db, window.EXPENSES_COLLECTION, expenseId);
                    await window.updateDoc(expenseDocRef, {
                        status: newStatus,
                        approvedBy: currentUserId,
                        approvalDate: new Date().toISOString()
                    });
                    window.showModal(`Expense ${newStatus}`, `Claim #${expenseId.substring(0, 8)}... has been ${newStatus}.`);
                } else {
                    // Local Mock Mode: Update the status locally
                    const expenseIndex = window.allExpenses.findIndex(e => e.id === expenseId);
                    if (expenseIndex !== -1) {
                        window.allExpenses[expenseIndex].status = newStatus;
                        window.allExpenses[expenseIndex].approvedBy = currentUserId;
                        renderContent(); // Rerender the approval list
                        window.showModal(`Action Successful (Local Mode)`, `Claim updated to ${newStatus} locally.`);
                    }
                }
                
            } catch (e) {
                console.error(`Error ${newStatus}ing expense:`, e);
                window.showModal('Action Failed', `Failed to update expense status: ${e.message}`);
            } finally {
                 // The onSnapshot listener (or renderContent in mock mode) handles refreshing the UI, so we just re-enable buttons.
                 approvalBtn.disabled = false;
                 approvalBtn.textContent = newStatus;
            }
        };


        // --- Initialization ---

        /**
         * Main setup function called after Firebase auth is ready or when skipping
         */
        window.setupApplication = async () => {
             // Start the listener/mock logic, which handles the final UI rendering.
             window.startExpenseListener();
        };

        // Tab switching logic
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', function() {
                // Deactivate all
                document.querySelectorAll('.tab-button').forEach(btn => {
                    btn.classList.remove('border-odoo-green', 'text-odoo-green');
                    btn.classList.add('text-gray-500', 'border-transparent');
                });
                document.querySelectorAll('.tab-pane').forEach(pane => {
                    pane.classList.add('hidden');
                });

                // Activate selected tab
                this.classList.add('border-odoo-green', 'text-odoo-green');
                this.classList.remove('text-gray-500', 'border-transparent');
                
                const tabId = this.getAttribute('data-tab');
                document.getElementById(tabId).classList.remove('hidden');

                // Re-render content when tab is switched 
                renderContent();
            });
        });

    </script>
</body>
</html>
