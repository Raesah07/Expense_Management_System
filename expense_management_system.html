<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Management System</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Load Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .view { display: none; }
        .view.active { display: block; }
        .modal { background-color: rgba(0, 0, 0, 0.5); }
        .nav-btn { transition: all 0.2s; }
        /* Style for disabled buttons while loading */
        .loading-disabled { opacity: 0.6; pointer-events: none; }
    </style>
</head>
<body class="bg-stone-100 text-stone-800">

    <div id="app" class="min-h-screen">
        <!-- Header -->
        <header class="bg-green-700 shadow-lg text-white p-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold">Odoo Expense Manager</h1>
            
            <div class="flex items-center space-x-4">
                <!-- User Info Display -->
                <span id="user-info" class="text-sm font-semibold">Initializing Application...</span>
                <!-- Only allow role change if data is ready -->
                <button id="role-change-btn" onclick="openModal('role-modal')" class="bg-white text-green-700 px-3 py-1 rounded-full font-semibold shadow-md hover:bg-green-100 transition duration-150 loading-disabled">
                    Change Role
                </button>
            </div>
        </header>

        <!-- Main Navigation -->
        <nav id="main-nav" class="bg-white shadow-md p-4 flex space-x-4 sticky top-0 z-10">
            <button id="nav-employee" data-role="employee" onclick="switchView('employee')" class="nav-btn px-4 py-2 rounded-lg text-stone-600 font-medium flex items-center loading-disabled">
                <i data-lucide="user" class="w-5 h-5 mr-2"></i> Employee Dashboard
            </button>
            <button id="nav-manager" data-role="manager" onclick="switchView('manager')" class="nav-btn px-4 py-2 rounded-lg text-stone-600 font-medium flex items-center loading-disabled">
                <i data-lucide="briefcase" class="w-5 h-5 mr-2"></i> Manager Approvals
            </button>
            <button id="nav-admin" data-role="admin" onclick="switchView('admin')" class="nav-btn px-4 py-2 rounded-lg text-stone-600 font-medium flex items-center loading-disabled">
                <i data-lucide="bar-chart-3" class="w-5 h-5 mr-2"></i> Admin Reports & Setup
            </button>
        </nav>

        <!-- Main Content Area -->
        <main class="p-6">
            
            <!-- Employee View -->
            <div id="employee-view" class="view">
                <div class="flex justify-between items-center mb-6 border-b pb-4">
                    <h2 class="text-3xl font-semibold text-green-700">My Expense History</h2>
                    <button id="new-claim-btn" onclick="openModal('expense-modal')" class="bg-indigo-600 text-white px-6 py-2 rounded-xl font-semibold shadow-lg hover:bg-indigo-700 transition duration-150 flex items-center loading-disabled">
                        <i data-lucide="plus-circle" class="w-5 h-5 mr-2"></i> New Claim
                    </button>
                </div>
                <div class="bg-white p-6 rounded-2xl shadow-xl overflow-x-auto">
                    <table class="min-w-full text-left text-sm font-light">
                        <thead class="border-b font-medium bg-stone-50">
                            <tr>
                                <th scope="col" class="px-6 py-3">Date</th>
                                <th scope="col" class="px-6 py-3">Description</th>
                                <th scope="col" class="px-6 py-3">Category</th>
                                <th scope="col" class="px-6 py-3 text-right">Amount</th>
                                <th scope="col" class="px-6 py-3 text-center">Status</th>
                            </tr>
                        </thead>
                        <tbody id="employee-expense-table">
                            <tr><td colspan="5" class="text-center py-4 text-stone-500">Loading expenses...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Manager View -->
            <div id="manager-view" class="view">
                <h2 class="text-3xl font-semibold text-green-700 mb-6 border-b pb-4">Manager Approval Dashboard</h2>

                <!-- Approval Queue -->
                <div class="mb-8">
                    <h3 class="text-2xl font-bold mb-4 flex items-center text-amber-700">
                        <i data-lucide="clock-3" class="w-6 h-6 mr-2"></i> Awaiting My Approval
                    </h3>
                    <div class="bg-white p-6 rounded-2xl shadow-xl overflow-x-auto">
                        <table class="min-w-full text-left text-sm font-light">
                            <thead class="border-b font-medium bg-stone-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Employee</th>
                                    <th scope="col" class="px-6 py-3">Date</th>
                                    <th scope="col" class="px-6 py-3">Description</th>
                                    <th scope="col" class="px-6 py-3 text-right">USD Equivalent</th>
                                    <th scope="col" class="px-6 py-3 text-center">Action</th>
                                </tr>
                            </thead>
                            <tbody id="manager-approval-table">
                                <tr><td colspan="5" class="text-center py-4 text-stone-500">Loading approvals...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Team Expense History -->
                <div>
                    <h3 class="text-2xl font-bold mb-4 flex items-center text-green-700">
                        <i data-lucide="history" class="w-6 h-6 mr-2"></i> Team Expense History
                    </h3>
                    <div class="bg-white p-6 rounded-2xl shadow-xl overflow-x-auto">
                        <table class="min-w-full text-left text-sm font-light">
                            <thead class="border-b font-medium bg-stone-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Employee</th>
                                    <th scope="col" class="px-6 py-3">Date</th>
                                    <th scope="col" class="px-6 py-3">Description</th>
                                    <th scope="col" class="px-6 py-3 text-right">Amount</th>
                                    <th scope="col" class="px-6 py-3 text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody id="manager-team-table">
                                <tr><td colspan="5" class="text-center py-4 text-stone-500">Loading team history...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Admin View -->
            <div id="admin-view" class="view">
                <h2 class="text-3xl font-semibold text-green-700 mb-6 border-b pb-4">Administration & Reporting</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-2xl shadow-xl">
                        <h3 class="text-xl font-bold mb-4">Total Expenses by Status</h3>
                        <canvas id="statusChart"></canvas>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-xl">
                        <h3 class="text-xl font-bold mb-4">Top Spending Categories</h3>
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>

                <h3 class="text-2xl font-bold text-indigo-600 mb-4 border-b pb-2">Approval Workflow Setup (Mock)</h3>
                <div class="bg-white p-6 rounded-2xl shadow-xl" id="flow-builder">
                    <div class="border-l-4 border-indigo-500 pl-4 mb-4 bg-indigo-50 p-3 rounded-lg">
                        <p class="font-semibold text-indigo-700">Step 1: Submission by Employee</p>
                        <p class="text-sm">Sends claim to immediate manager.</p>
                    </div>
                    <div class="border-l-4 border-amber-500 pl-4 mb-4 bg-amber-50 p-3 rounded-lg">
                        <p class="font-semibold text-amber-700">Step 2: Manager Review</p>
                        <p class="text-sm">Required for all claims under $1,000.</p>
                        <label class="flex items-center mt-2 text-sm text-stone-600">
                            <input type="checkbox" onchange="toggleConditional(this)" class="rounded text-indigo-600">
                            <span class="ml-2">Require Finance review if conditional</span>
                        </label>
                        <div id="conditional-rules" style="display:none;" class="mt-3 p-3 border border-dashed rounded-lg bg-white">
                            <p class="text-xs font-medium">Conditional Rules (Finance Review):</p>
                            <ul class="list-disc list-inside text-xs mt-1">
                                <li>If amount > $500 AND Category is 'Travel'.</li>
                            </ul>
                        </div>
                    </div>
                    <div class="border-l-4 border-green-500 pl-4 bg-green-50 p-3 rounded-lg">
                        <p class="font-semibold text-green-700">Step 3: Auto-Payment</p>
                        <p class="text-sm">Final approval triggers payment queue.</p>
                    </div>
                    
                    <button onclick="addFlowStep()" class="mt-4 bg-stone-200 text-stone-700 px-4 py-2 rounded-lg font-medium hover:bg-stone-300 transition duration-150 flex items-center">
                        <i data-lucide="plus" class="w-5 h-5 mr-2"></i> Add New Step
                    </button>
                </div>

            </div>

        </main>
    </div>

    <!-- Modal for Expense Submission -->
    <div id="expense-modal" class="modal fixed inset-0 hidden items-center justify-center z-50 transition duration-300">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-lg">
            <div class="flex justify-between items-center mb-6 border-b pb-3">
                <h3 class="text-2xl font-bold text-green-700">Submit New Expense Claim</h3>
                <button onclick="closeModal('expense-modal')" class="text-stone-400 hover:text-stone-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <form id="expense-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="date" class="block text-sm font-medium text-stone-700 mb-1">Date</label>
                        <input type="date" id="date" name="date" required class="w-full p-2 border border-stone-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="category" class="block text-sm font-medium text-stone-700 mb-1">Category</label>
                        <select id="category" name="category" required class="w-full p-2 border border-stone-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                            <option value="">Select Category</option>
                            <option value="Travel">Travel</option>
                            <option value="Meals">Meals</option>
                            <option value="Office Supplies">Office Supplies</option>
                            <option value="Software">Software/Subscriptions</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                </div>
                
                <div>
                    <label for="description" class="block text-sm font-medium text-stone-700 mb-1">Description</label>
                    <textarea id="description" name="description" rows="2" required class="w-full p-2 border border-stone-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div class="col-span-2">
                        <label for="amount" class="block text-sm font-medium text-stone-700 mb-1">Amount</label>
                        <input type="number" id="amount" name="amount" step="0.01" min="0.01" required class="w-full p-2 border border-stone-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label for="currency" class="block text-sm font-medium text-stone-700 mb-1">Currency</label>
                        <select id="currency" name="currency" required class="w-full p-2 border border-stone-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 bg-white">
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                            <option value="GBP">GBP</option>
                        </select>
                    </div>
                </div>

                <div class="pt-4 flex justify-end space-x-3">
                    <button type="button" onclick="closeModal('expense-modal')" class="px-4 py-2 text-stone-600 bg-stone-100 rounded-xl font-semibold hover:bg-stone-200 transition duration-150">
                        Cancel
                    </button>
                    <button type="submit" id="submit-expense-btn" class="px-6 py-2 bg-green-600 text-white rounded-xl font-semibold shadow-md hover:bg-green-700 transition duration-150 flex items-center">
                        Submit Claim
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal for Role Selection -->
    <div id="role-modal" class="modal fixed inset-0 hidden items-center justify-center z-50 transition duration-300">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md">
            <h3 class="text-2xl font-bold mb-6 text-indigo-700 border-b pb-2">Select User Role</h3>
            <div class="space-y-4" id="role-selector-container">
                <!-- Buttons dynamically generated -->
            </div>
            <p class="text-xs text-stone-500 mt-4">Note: Your current Firebase ID is used to map to a role. Use this to switch views.</p>
        </div>
    </div>
    
    <!-- Custom Error/Success Modal -->
    <div id="status-message-modal" class="modal fixed inset-0 hidden items-center justify-center z-50 transition duration-300">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm text-center">
            <div id="status-icon" class="mb-3"></div>
            <p id="status-title" class="text-xl font-bold mb-2"></p>
            <p id="status-message" class="text-sm text-stone-600"></p>
            <button onclick="closeModal('status-message-modal')" class="mt-4 px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700">OK</button>
        </div>
    </div>

    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Load Firebase Modules -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, onSnapshot, query, setDoc, addDoc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Set Firestore log level for debugging
        setLogLevel('Debug');

        // --- GLOBAL STATE ---
        window.app = null;
        window.db = null;
        window.auth = null;
        window.currentUid = null;
        window.isAuthReady = false;
        window.isDataReady = false; 
        
        window.allExpenses = [];
        window.allUserRoles = []; 
        window.currentRoleUser = null; 
        
        // --- CONFIGURATION SETUP (WITH LOCAL/DEV FALLBACK) ---
        
        // 1. Check for Canvas injected variables
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : '{}';
        window.firebaseConfig = {};
        
        // 2. Local Fallback Configuration (for running via file:// or simple local server)
        const MOCK_FIREBASE_CONFIG = {
            // A simple placeholder config that allows anonymous sign-in
            apiKey: "MOCK_API_KEY", 
            authDomain: "mock-project.firebaseapp.com",
            projectId: "mock-project-id", // Must have a project ID to init
            storageBucket: "mock-project.appspot.com",
            messagingSenderId: "123456789012",
            appId: "1:123456789012:web:abcdef01234567890"
        };
        
        // Attempt to parse injected config, fall back to mock if empty or failed
        let isMockConfig = false;
        try {
            window.firebaseConfig = JSON.parse(firebaseConfigString);
            if (!window.firebaseConfig.projectId) {
                 throw new Error("Injected config lacks project ID. Falling back.");
            }
        } catch (e) {
            console.warn("Using MOCK Firebase Configuration. Real-time data will not be persistent across sessions if running outside Canvas.");
            window.firebaseConfig = MOCK_FIREBASE_CONFIG;
            isMockConfig = true;
        }

        // Mock data for initial user setup/demo (roles are identified by unique integer IDs)
        const MOCK_USER_ROLES = [
            { id: 1, name: 'Admin User (ID: 1)', role: 'admin', managerId: null },
            { id: 2, name: 'Eleanor Vance (ID: 2)', role: 'employee', managerId: 4 }, 
            { id: 3, name: 'Marcus Holloway (ID: 3)', role: 'employee', managerId: 4 }, 
            { id: 4, name: 'Jane Smith (ID: 4)', role: 'manager', managerId: 1 },     
        ];
        
        // Mock exchange rates
        const USD_RATE_MOCK = { 'USD': 1.00, 'EUR': 1.08, 'GBP': 1.25 };
        window.USD_RATE_MOCK = USD_RATE_MOCK;

        const roleCollectionPath = `artifacts/${window.appId}/public/data/user_roles`;
        const expenseCollectionPath = `artifacts/${window.appId}/public/data/expenses`;

        // --- FIREBASE INITIALIZATION AND AUTHENTICATION ---
        async function initializeFirebase() {
            try {
                if (window.app) return; 

                // 1. Initialize App
                window.app = initializeApp(window.firebaseConfig);
                window.db = getFirestore(window.app);
                window.auth = getAuth(window.app);
                updateUserInfoDisplay('Connecting to Firebase...');

                // 2. Authenticate
                if (initialAuthToken && !isMockConfig) {
                    await signInWithCustomToken(window.auth, initialAuthToken);
                    console.log("Authenticated using custom token.");
                } else {
                    await signInAnonymously(window.auth);
                    console.log("Authenticated anonymously (MOCK or local run).");
                }

                // 3. Wait for Auth State Change
                onAuthStateChanged(window.auth, async (user) => {
                    if (user) {
                        window.currentUid = user.uid;
                        window.isAuthReady = true;
                        updateUserInfoDisplay('Auth Successful. Fetching Data...');
                        
                        // 4. Start data listeners and finalize app startup
                        setupListeners();
                        console.log("Auth State Changed: User is logged in.");
                    } else {
                        console.error("Authentication failed or user logged out.");
                        window.showStatusMessage('Error', 'Authentication Failed. Please check console.', 'red');
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                window.showStatusMessage('Critical Error', `Initialization failed: ${error.message}. Check console for details.`, 'red');
            }
        }

        // --- FIREBASE LISTENERS ---
        function setupListeners() {
            let rolesFetched = false;
            let expensesFetched = false;

            const checkReady = () => {
                if (rolesFetched && expensesFetched && !window.isDataReady) {
                    window.isDataReady = true;
                    console.log("App Ready: Both roles and expenses fetched.");
                    
                    // Set default user role on first load (Eleanor Vance/ID 2)
                    if (!window.currentRoleUser && window.allUserRoles.length > 0) {
                        const defaultRole = window.allUserRoles.find(r => r.id === 2) || window.allUserRoles[0];
                        window.currentRoleUser = defaultRole;
                        window.switchView(defaultRole.role);
                    }
                    
                    // Remove loading state from UI elements
                    document.querySelectorAll('.loading-disabled').forEach(el => el.classList.remove('loading-disabled'));
                }
            };
            
            // 1. Listen for User Roles
            onSnapshot(collection(window.db, roleCollectionPath), async (snapshot) => {
                updateUserInfoDisplay('Fetching User Roles...');
                const fetchedRoles = snapshot.docs.map(doc => ({ 
                    ...doc.data(), 
                    id: parseInt(doc.id, 10) || doc.id 
                })).filter(r => r.role); 
                
                window.allUserRoles = fetchedRoles;
                
                // If roles are empty on first snapshot, seed the mock data
                if (!rolesFetched && fetchedRoles.length < MOCK_USER_ROLES.length) {
                    console.warn("Roles collection empty or incomplete. Seeding mock user roles.");
                    await seedUserRoles();
                    return; 
                }

                rolesFetched = true;
                window.renderRoleSelector();
                checkReady();
                console.log(`Roles Listener: ${fetchedRoles.length} roles loaded.`);
            }, (error) => {
                 console.error("Firestore Roles Listener Error:", error);
                 rolesFetched = true;
                 checkReady();
            });
            
            // 2. Listen for Expenses
            onSnapshot(collection(window.db, expenseCollectionPath), (snapshot) => {
                updateUserInfoDisplay('Fetching Expense Data...');
                window.allExpenses = snapshot.docs.map(doc => ({ 
                    ...doc.data(), 
                    docId: doc.id,
                    amount: parseFloat(doc.data().amount) || 0,
                    userId: parseInt(doc.data().userId, 10) || doc.data().userId 
                })).sort((a, b) => new Date(b.date) - new Date(a.date));

                expensesFetched = true;
                
                // Re-render the current active view with the new data
                if (window.currentRoleUser && window.isDataReady) {
                     window.switchView(window.currentRoleUser.role);
                }
                checkReady();
                console.log(`Expenses Listener: ${window.allExpenses.length} expenses loaded.`);
            }, (error) => {
                 console.error("Firestore Expenses Listener Error:", error);
                 expensesFetched = true;
                 checkReady();
            });
        }
        
        // --- SEEDING MOCK DATA FOR DEMO ---
        async function seedUserRoles() {
            const roleCollectionRef = collection(window.db, roleCollectionPath);
            try {
                for (const user of MOCK_USER_ROLES) {
                    // Using setDoc with ID as the document ID
                    await setDoc(window.doc(roleCollectionRef, user.id.toString()), {
                        name: user.name,
                        role: user.role,
                        managerId: user.managerId,
                    });
                }
                console.log("User roles seeded successfully.");
            } catch (e) {
                console.error("Seeding failed:", e);
                window.showStatusMessage('Seeding Error', 'Failed to seed demo roles. Data tables may be empty.', 'red');
            }
        }

        // --- EXPOSE FIREBASE FUNCTIONS GLOBALLY ---
        window.doc = doc;
        window.collection = collection;
        window.addDoc = addDoc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.initializeFirebase = initializeFirebase;
    </script>

    <script type="module">
        // Import lucide for icon rendering
        lucide.createIcons();

        // --- UTILITY FUNCTIONS ---
        const getUserById = (id) => window.allUserRoles.find(u => u.id === id) || { name: `User ID: ${id}`, role: 'N/A' };
        window.getUserById = getUserById;
        
        const getStatusBadge = (status) => {
            const colors = {
                'Approved': 'bg-green-100 text-green-800',
                'Pending': 'bg-amber-100 text-amber-800',
                'Rejected': 'bg-red-100 text-red-800',
            };
            return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${colors[status] || 'bg-stone-100 text-stone-800'}">${status}</span>`;
        };
        
        function showStatusMessage(title, message, type = 'green') {
            const modal = document.getElementById('status-message-modal');
            const iconDiv = document.getElementById('status-icon');
            const titleEl = document.getElementById('status-title');
            const messageEl = document.getElementById('status-message');
            const okBtn = modal.querySelector('button');

            const colorMap = {
                'green': { icon: 'check-circle', color: 'text-green-600', btn: 'bg-green-600 hover:bg-green-700' },
                'red': { icon: 'x-circle', color: 'text-red-600', btn: 'bg-red-600 hover:bg-red-700' },
                'amber': { icon: 'alert-triangle', color: 'text-amber-600', btn: 'bg-amber-600 hover:bg-amber-700' }
            };

            const colors = colorMap[type] || colorMap.green;
            iconDiv.innerHTML = `<i data-lucide="${colors.icon}" class="w-12 h-12 mx-auto ${colors.color}"></i>`;
            titleEl.textContent = title;
            messageEl.textContent = message;
            okBtn.className = `mt-4 px-4 py-2 text-white rounded-lg font-semibold ${colors.btn}`;
            
            lucide.createIcons();
            openModal('status-message-modal');
        }
        window.showStatusMessage = showStatusMessage;


        // --- UI RENDER FUNCTIONS ---
        function updateUserInfoDisplay(status = null) {
            const user = window.currentRoleUser;
            let display = status;

            if (!status) {
                 display = user 
                    ? `User: ${user.name} | Role: ${user.role.toUpperCase()}`
                    : `Data Loaded. Select Role.`;
            }
            document.getElementById('user-info').textContent = display;
        }
        window.updateUserInfoDisplay = updateUserInfoDisplay;


        function renderRoleSelector() {
            const roleContainer = document.getElementById('role-selector-container');
            if (!roleContainer) return;
            
            roleContainer.innerHTML = window.allUserRoles.map(u => {
                let color = u.role === 'employee' ? 'indigo' : u.role === 'manager' ? 'amber' : 'red';
                let icon = u.role === 'employee' ? 'user' : u.role === 'manager' ? 'briefcase' : 'bar-chart-3';
                let description = u.role === 'employee' ? 'View personal expenses and submit new claims.' : 
                                  u.role === 'manager' ? 'Approve/reject team expenses.' : 'View overall reports and configure workflows.';
                
                return `
                    <button onclick="switchRole(${u.id}); closeModal('role-modal')" class="w-full text-left p-4 bg-${color}-50 hover:bg-${color}-100 rounded-xl border border-${color}-200 transition duration-150">
                        <p class="font-bold text-${color}-700 flex items-center capitalize"><i data-lucide="${icon}" class="w-5 h-5 mr-2"></i> ${u.role} (${u.name})</p>
                        <p class="text-sm text-${color}-600 mt-1">${description}</p>
                    </button>
                `;
            }).join('');
            lucide.createIcons();
        }

        // --- VIEW RENDERERS (CALLED BY LISTENERS) ---
        function renderEmployeeTable() {
            const tableBody = document.getElementById('employee-expense-table');
            if (!window.currentRoleUser || !window.isDataReady) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-stone-500">App data is still loading...</td></tr>`;
                return;
            }
            
            // Filter by the currently active user's ID
            const userIdToFilter = window.currentRoleUser.id; 
            const employeeExpenses = window.allExpenses.filter(e => e.userId === userIdToFilter);
            
            if (employeeExpenses.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-stone-500">No expenses found for ${window.currentRoleUser.name}.</td></tr>`;
                return;
            }

            tableBody.innerHTML = employeeExpenses.map(e => `
                <tr class="border-b hover:bg-stone-50">
                    <td class="px-6 py-3">${e.date}</td>
                    <td class="px-6 py-3">${e.description}</td>
                    <td class="px-6 py-3">${e.category}</td>
                    <td class="px-6 py-3 text-right">${e.amount.toFixed(2)} ${e.currency}</td>
                    <td class="px-6 py-3 text-center">${getStatusBadge(e.status)}</td>
                </tr>
            `).join('');
        }

        function renderManagerTables() {
            const managerId = window.currentRoleUser ? window.currentRoleUser.id : null;
            const approvalTable = document.getElementById('manager-approval-table');
            const teamTable = document.getElementById('manager-team-table');
            
            if (!managerId || !window.isDataReady) {
                approvalTable.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-stone-500">App data is still loading...</td></tr>`;
                teamTable.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-stone-500">App data is still loading...</td></tr>`;
                return;
            }
            
            // Find all employees managed by the current manager's ID
            const teamIds = window.allUserRoles.filter(u => u.managerId === managerId).map(u => u.id); 
            const teamExpenses = window.allExpenses.filter(e => teamIds.includes(e.userId));
            
            // Approval Queue: Pending expenses from the team
            const pendingApprovals = teamExpenses.filter(e => e.status === 'Pending');

            if (pendingApprovals.length === 0) {
                approvalTable.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-stone-500">No pending approvals!</td></tr>`;
            } else {
                approvalTable.innerHTML = pendingApprovals.map(e => `
                    <tr class="border-b hover:bg-stone-50">
                        <td class="px-6 py-3">${getUserById(e.userId).name}</td>
                        <td class="px-6 py-3">${e.date}</td>
                        <td class="px-6 py-3">${e.description}</td>
                        <td class="px-6 py-3 text-right">
                            $${(e.amount * (window.USD_RATE_MOCK[e.currency] || 1)).toFixed(2)} USD
                        </td>
                        <td class="px-6 py-3 text-center space-x-2">
                            <button onclick="handleApproval('${e.docId}', 'Approved')" class="text-green-600 hover:text-green-800 font-medium p-1 rounded-lg">Approve</button>
                            <button onclick="handleApproval('${e.docId}', 'Rejected')" class="text-red-600 hover:text-red-800 font-medium p-1 rounded-lg">Reject</button>
                        </td>
                    </tr>
                `).join('');
            }

            // Team History: All expenses from the team
            if (teamExpenses.length === 0) {
                teamTable.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-stone-500">No team expense history found.</td></tr>`;
            } else {
                teamTable.innerHTML = teamExpenses.map(e => `
                    <tr class="border-b hover:bg-stone-50">
                        <td class="px-6 py-3">${getUserById(e.userId).name}</td>
                        <td class="px-6 py-3">${e.date}</td>
                        <td class="px-6 py-3">${e.description}</td>
                        <td class="px-6 py-3 text-right">${e.amount.toFixed(2)} ${e.currency}</td>
                        <td class="px-6 py-3 text-center">${getStatusBadge(e.status)}</td>
                    </tr>
                `).join('');
            }
        }

        // --- CHART RENDERER ---
        let statusChart, categoryChart;
        
        function calculateChartData() {
            const statusCounts = window.allExpenses.reduce((acc, e) => {
                acc[e.status] = (acc[e.status] || 0) + 1;
                return acc;
            }, {});

            const categoryTotals = window.allExpenses.reduce((acc, e) => {
                const usdAmount = e.amount * (window.USD_RATE_MOCK[e.currency] || 1);
                acc[e.category] = (acc[e.category] || 0) + usdAmount;
                return acc;
            }, {});
            
            return { statusCounts, categoryTotals };
        }

        function renderAdminCharts() {
            if (!window.isDataReady) return;
            const { statusCounts, categoryTotals } = calculateChartData();

            // 1. Status Chart
            const statusCtx = document.getElementById('statusChart');
            if (!statusCtx) return;
            if (statusChart) statusChart.destroy();
            statusChart = new Chart(statusCtx.getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: Object.keys(statusCounts),
                    datasets: [{
                        data: Object.values(statusCounts),
                        backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#a8a29e'], // Green, Amber, Red, Stone
                        hoverOffset: 4
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'top' }, title: { display: false } } }
            });

            // 2. Category Chart
            const categoryCtx = document.getElementById('categoryChart');
            if (!categoryCtx) return;
            if (categoryChart) categoryChart.destroy();
            categoryChart = new Chart(categoryCtx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: Object.keys(categoryTotals),
                    datasets: [{
                        label: 'Total Spent (USD)',
                        data: Object.values(categoryTotals).map(v => v.toFixed(2)),
                        backgroundColor: '#4f46e5', // Indigo
                    }]
                },
                options: { responsive: true, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false }, title: { display: false } } }
            });
        }
        
        // --- VIEW CONTROLLERS ---

        // Switches the active role user based on the selected ID
        window.switchRole = (userId) => {
            const idToFind = typeof userId === 'string' ? userId : parseInt(userId, 10);
            const user = window.allUserRoles.find(u => u.id === idToFind);

            if (user) {
                window.currentRoleUser = user;
                window.switchView(user.role);
            } else {
                window.showStatusMessage('Error', 'User ID not found in roles data.', 'red');
            }
        }
        
        // Switches the active view tab
        window.switchView = (viewName) => {
            if (!window.isDataReady) {
                 window.showStatusMessage('Initialization', 'App data is still loading. Please wait a moment.', 'amber');
                 return;
            }

            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            const targetView = document.getElementById(`${viewName}-view`);
            if (targetView) targetView.classList.add('active');

            document.querySelectorAll('.nav-btn').forEach(b => {
                 b.classList.remove('bg-indigo-100', 'text-indigo-700');
                 b.classList.add('text-stone-600');
            });
            const activeBtn = document.querySelector(`.nav-btn[data-role="${viewName}"]`);
            if (activeBtn) {
                activeBtn.classList.add('bg-indigo-100', 'text-indigo-700');
            }

            // Update data based on the new role
            updateUserInfoDisplay();
            if (viewName === 'employee') {
                renderEmployeeTable();
            } else if (viewName === 'manager') {
                renderManagerTables();
            } else if (viewName === 'admin') {
                renderAdminCharts();
            }
        }

        // --- FIREBASE WRITE OPERATIONS ---
        
        // Manager action: Approve or Reject
        window.handleApproval = async (docId, newStatus) => {
            if (!window.db) { window.showStatusMessage('Error', 'Database not connected.', 'red'); return; }

            try {
                const expenseCollectionPath = `artifacts/${window.appId}/public/data/expenses`;
                const expenseRef = window.doc(window.db, expenseCollectionPath, docId);
                await window.updateDoc(expenseRef, {
                    status: newStatus,
                    managerId: window.currentRoleUser.id,
                    reviewedAt: new Date().toISOString()
                });
                window.showStatusMessage('Success', `Expense ${newStatus} successfully!`, 'green');
            } catch (error) {
                console.error("Error updating document:", error);
                window.showStatusMessage('Error', 'Failed to update expense status.', 'red');
            }
        }
        
        // Expense Form Submission
        document.getElementById('expense-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('submit-expense-btn').disabled = true;

            if (!window.db || !window.currentRoleUser) { 
                window.showStatusMessage('Error', 'Application not fully loaded or not authenticated.', 'red');
                document.getElementById('submit-expense-btn').disabled = false;
                return;
            }
            
            const expenseCollectionPath = `artifacts/${window.appId}/public/data/expenses`;
            const formData = new FormData(e.target);
            const expenseCollectionRef = window.collection(window.db, expenseCollectionPath);
            
            try {
                const newExpense = {
                    userId: window.currentRoleUser.id, 
                    date: formData.get('date'),
                    description: formData.get('description'),
                    category: formData.get('category'),
                    amount: parseFloat(formData.get('amount')),
                    currency: formData.get('currency').toUpperCase(),
                    status: 'Pending', 
                    submittedAt: new Date().toISOString()
                };

                await window.addDoc(expenseCollectionRef, newExpense);
                
                closeModal('expense-modal');
                e.target.reset();
                window.showStatusMessage('Success', 'Your expense claim has been submitted successfully!', 'green');

            } catch (error) {
                console.error("Firestore Submission Error:", error);
                window.showStatusMessage('Submission Failed', `An error occurred: ${error.message}. Please try again.`, 'red');
            } finally {
                document.getElementById('submit-expense-btn').disabled = false;
            }
        });

        // --- MOCK ADMIN FUNCTIONS (No DB writes required here) ---
        window.addFlowStep = () => {
             // Mock function for demo purposes
             window.showStatusMessage('Demo Feature', 'This demonstrates adding a new step to the workflow.', 'amber');
        }
        window.toggleConditional = (checkbox) => {
             document.getElementById('conditional-rules').style.display = checkbox.checked ? 'block' : 'none';
        }


        // --- GENERIC MODAL HANDLERS ---
        window.openModal = (modalId) => { document.getElementById(modalId).classList.replace('hidden', 'flex'); }
        window.closeModal = (modalId) => { document.getElementById(modalId).classList.replace('flex', 'hidden'); }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            window.initializeFirebase();
            lucide.createIcons();
        });
    </script>

</body>
</html>
