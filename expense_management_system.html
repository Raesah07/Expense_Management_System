<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Expense Manager (Dynamic Users)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal { background-color: rgba(0, 0, 0, 0.5); display: none; }
    </style>
</head>
<body class="bg-stone-50 text-stone-800">

    <header class="bg-green-700 text-white p-4 shadow-lg flex justify-between items-center">
        <h1 class="text-2xl font-bold">Simple Expense Manager (API Ready)</h1>
        <div class="flex items-center space-x-4">
            <span id="user-info" class="text-sm">User: Select Role | Role: NONE</span>
            <button onclick="showRoleSelection()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow transition duration-150">Change Role</button>
        </div>
    </header>

    <div id="app" class="min-h-screen p-8">
        </div>

    <div id="role-selection-modal" class="modal fixed inset-0 z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md">
            <h2 class="text-xl font-bold mb-4 border-b pb-2">Select User Role to Begin</h2>
            <div id="user-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                <p class="text-center text-gray-500">Loading users...</p>
            </div>
            <p class="mt-4 text-xs text-gray-500 border-t pt-2">
                <button onclick="showUserManagementModal()" class="text-blue-600 hover:underline">Manage Users (Create/Delete)</button>
            </p>
        </div>
    </div>
    
    <div id="user-management-modal" class="modal fixed inset-0 z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-xl">
            <h2 class="text-xl font-bold mb-4 border-b pb-2">Manage Users</h2>

            <div class="mb-6 p-4 border rounded-lg bg-gray-50">
                <h3 class="font-semibold mb-2">Create New User</h3>
                <input id="new-user-name" type="text" placeholder="Enter Name" class="p-2 border rounded w-1/2 mr-2">
                <select id="new-user-role" class="p-2 border rounded mr-2">
                    <option value="Employee">Employee</option>
                    <option value="Manager">Manager</option>
                    <option value="Admin">Admin</option>
                </select>
                <button onclick="createUser()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-150">Create</button>
            </div>

            <div class="max-h-60 overflow-y-auto pr-2">
                <h3 class="font-semibold mb-2">Existing Users (Cannot delete users with claims)</h3>
                <div id="existing-users-list" class="space-y-1">
                    <p class="text-center text-gray-500">Loading...</p>
                </div>
            </div>

            <button onclick="closeUserManagementModal()" class="mt-4 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-150">Close</button>
        </div>
    </div>

    <div id="claim-modal" class="modal fixed inset-0 z-50 flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md">
            <h2 class="text-xl font-bold mb-4 border-b pb-2">Submit New Expense Claim</h2>
            <label class="block mb-2">Description</label>
            <input id="claim-description" type="text" class="w-full p-2 border rounded mb-3" required>
            
            <label class="block mb-2">Category</label>
            <select id="claim-category" class="w-full p-2 border rounded mb-3">
                <option value="Meals">Meals</option>
                <option value="Travel">Travel</option>
                <option value="Office Supplies">Office Supplies</option>
                <option value="Software">Software</option>
            </select>
            
            <div class="flex space-x-3 mb-3">
                <div class="w-1/2">
                    <label class="block mb-2">Amount</label>
                    <input id="claim-amount" type="number" step="0.01" class="w-full p-2 border rounded" required>
                </div>
                <div class="w-1/2">
                    <label class="block mb-2">Currency</label>
                    <select id="claim-currency" class="w-full p-2 border rounded">
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                        <option value="GBP">GBP</option>
                    </select>
                </div>
            </div>

            <div class="flex justify-end space-x-3">
                <button onclick="closeClaimModal()" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg transition duration-150">Cancel</button>
                <button onclick="submitClaim()" class="bg-green-700 hover:bg-green-800 text-white font-bold py-2 px-4 rounded-lg transition duration-150">Submit</button>
            </div>
        </div>
    </div>


    <script>
        const API_BASE_URL = 'http://localhost:3000/api';
        let currentUser = null; // userId, employeeName, role
        
        document.addEventListener('DOMContentLoaded', () => {
            // Check if user info is in localStorage (for persistence)
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                updateUserInfo();
                renderView(currentUser.role);
            } else {
                showRoleSelection();
            }
        });
        
        // --- UTILITY FUNCTIONS ---
        async function fetchData(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, options);
                if (!response.ok) {
                    // Check if response body has JSON error message
                    const errorData = await response.json().catch(() => ({ message: `HTTP error! status: ${response.status}` }));
                    throw new Error(errorData.message);
                }
                return await response.json();
            } catch (error) {
                console.error("API Error:", error);
                document.getElementById('app').innerHTML = `<p class="text-red-600 text-center mt-8">API Error: Failed to fetch data from ${API_BASE_URL}. Ensure server.js is running. Details: ${error.message}</p>`;
                return null;
            }
        }
        
        function updateUserInfo() {
            if (currentUser) {
                document.getElementById('user-info').textContent = `User: ${currentUser.employeeName} | Role: ${currentUser.role.toUpperCase()}`;
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
            } else {
                document.getElementById('user-info').textContent = 'User: Select Role | Role: NONE';
                localStorage.removeItem('currentUser');
            }
        }
        
        function showRoleSelection() {
            renderUserRoleSelection();
            document.getElementById('role-selection-modal').style.display = 'flex';
        }
        
        function closeRoleSelection() {
            document.getElementById('role-selection-modal').style.display = 'none';
        }
        
        // --- VIEW RENDERING FUNCTIONS ---
        function renderView(role) {
            const app = document.getElementById('app');
            app.innerHTML = '';
            
            switch (role) {
                case 'Employee':
                    app.innerHTML = `
                        <div class="mt-8 flex justify-between items-center">
                            <h2 class="text-3xl font-semibold text-green-700">My Expense Claims</h2>
                            <button onclick="showClaimModal()" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-md transition duration-150 flex items-center">
                                <i data-lucide="plus" class="w-5 h-5 mr-2"></i> Submit New Claim
                            </button>
                        </div>
                        <div id="employee-table-container" class="mt-6 bg-white p-6 rounded-xl shadow-lg">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead>
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    </tr>
                                </thead>
                                <tbody id="employee-claims-body" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="5" class="py-4 text-center text-gray-500">Loading claims...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    `;
                    renderEmployeeTable();
                    break;
                case 'Manager':
                    app.innerHTML = `
                        <div class="mt-8">
                            <h2 class="text-3xl font-semibold text-orange-600">Approval Queue</h2>
                        </div>
                        <div id="manager-table-container" class="mt-6 bg-white p-6 rounded-xl shadow-lg">
                            <h3 class="text-xl font-medium text-orange-600 mb-4 flex items-center">
                                <i data-lucide="alert-triangle" class="w-6 h-6 mr-2"></i> Pending Approvals
                            </h3>
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead>
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">USD Equivalent</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="manager-claims-body" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="5" class="py-4 text-center text-gray-500">Loading claims...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    `;
                    renderManagerApprovals();
                    break;
                case 'Admin':
                    // Admin view (simplified as no backend for summary was built)
                    app.innerHTML = `
                        <div class="mt-8">
                            <h2 class="text-3xl font-semibold text-red-700">Admin Dashboard</h2>
                        </div>
                        <div class="mt-6 p-6 bg-white rounded-xl shadow-lg">
                            <p class="text-lg text-gray-600">Admin View is active. This view would typically contain global reports and configuration settings.</p>
                        </div>
                    `;
                    break;
                default:
                    app.innerHTML = '<p class="text-center mt-12 text-gray-500">Please select a user role to begin.</p>';
            }
            // Re-initialize Lucide icons
            lucide.createIcons();
        }
        
        // --- EXPENSE API CALLS (EXISTING) ---
        async function renderEmployeeTable() {
            const claims = await fetchData(`/expenses/myclaims?userId=${currentUser.userId}`);
            const tbody = document.getElementById('employee-claims-body');
            tbody.innerHTML = '';
            
            if (!claims || claims.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-gray-500">No claims submitted yet.</td></tr>';
                return;
            }
            
            claims.forEach(claim => {
                const row = tbody.insertRow();
                row.className = 'whitespace-nowrap';
                row.insertCell().textContent = claim.date;
                row.insertCell().textContent = claim.description;
                row.insertCell().textContent = claim.category;
                row.insertCell().textContent = `${claim.currency} ${claim.amount.toFixed(2)}`;
                row.insertCell().innerHTML = `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusClass(claim.status)}">${claim.status}</span>`;
            });
        }
        
        async function renderManagerApprovals() {
            // NOTE: Manager ID is hardcoded as 4 for Jane Smith in server.js's MANAGED_EMPLOYEES list
            const pendingClaims = await fetchData(`/expenses/pending?managerId=4`); 
            const tbody = document.getElementById('manager-claims-body');
            tbody.innerHTML = '';
            
            if (!pendingClaims || pendingClaims.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="py-4 text-center text-gray-500">No pending claims for your team.</td></tr>';
                return;
            }
            
            pendingClaims.forEach(claim => {
                const row = tbody.insertRow();
                row.className = 'whitespace-nowrap';
                row.insertCell().textContent = claim.employeeName;
                row.insertCell().textContent = claim.date;
                row.insertCell().textContent = claim.description;
                row.insertCell().textContent = `USD ${claim.usdEquivalent.toFixed(2)}`;
                
                const actionCell = row.insertCell();
                actionCell.className = 'px-6 py-4 space-x-2';
                actionCell.innerHTML = `
                    <button onclick="updateClaimStatus('${claim.docId}', 'Approved')" class="text-green-600 hover:text-green-900 font-semibold">Approve</button>
                    <button onclick="updateClaimStatus('${claim.docId}', 'Rejected')" class="text-red-600 hover:text-red-900 font-semibold ml-2">Reject</button>
                `;
            });
        }
        
        async function updateClaimStatus(docId, status) {
            const payload = { 
                status: status,
                approverId: currentUser.userId // Manager's ID
            };
            
            const result = await fetchData(`/expenses/${docId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (result) {
                renderManagerApprovals(); // Refresh table
                alert(`Claim ${docId} ${status.toLowerCase()} successfully.`);
            }
        }
        
        async function submitClaim() {
            const date = new Date().toISOString().split('T')[0];
            const description = document.getElementById('claim-description').value;
            const category = document.getElementById('claim-category').value;
            const amount = parseFloat(document.getElementById('claim-amount').value);
            const currency = document.getElementById('claim-currency').value;
            
            if (!description || isNaN(amount) || amount <= 0) {
                alert("Please fill out all fields with valid data.");
                return;
            }
            
            const payload = {
                userId: currentUser.userId,
                employeeName: currentUser.employeeName,
                date: date,
                description: description,
                category: category,
                amount: amount,
                currency: currency
            };
            
            const result = await fetchData(`/expenses`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            if (result) {
                closeClaimModal();
                renderEmployeeTable();
                alert("Claim submitted successfully!");
            }
        }

        // --- DYNAMIC USER SELECTION AND MANAGEMENT FUNCTIONS (NEW) ---
        
        async function renderUserRoleSelection() {
            const users = await fetchData('/users');
            const userListDiv = document.getElementById('user-list');
            userListDiv.innerHTML = '';
            
            if (!users || users.length === 0) {
                userListDiv.innerHTML = '<p class="text-center text-red-500">No users found. Use Manage Users to create one.</p>';
                return;
            }
            
            users.forEach(user => {
                const color = user.role === 'Admin' ? 'red' : (user.role === 'Manager' ? 'orange' : 'green');
                const description = user.role === 'Admin' ? 'View overall system summary.' : 
                                    (user.role === 'Manager' ? 'Approve/reject team expenses.' : 
                                    'View personal expenses and submit new claims.');

                userListDiv.innerHTML += `
                    <div onclick="selectUser(${user.userId}, '${user.employeeName}', '${user.role}')"
                         class="p-3 border border-${color}-200 rounded-lg shadow-sm hover:bg-${color}-50 cursor-pointer transition duration-150">
                        <p class="font-semibold text-lg text-${color}-700">${user.employeeName}</p>
                        <p class="text-sm text-gray-600">Role: ${user.role} - ${description}</p>
                    </div>
                `;
            });
        }
        
        function selectUser(userId, employeeName, role) {
            currentUser = { userId, employeeName, role };
            updateUserInfo();
            closeRoleSelection();
            renderView(role);
        }

        function showUserManagementModal() {
            document.getElementById('role-selection-modal').style.display = 'none'; 
            document.getElementById('user-management-modal').style.display = 'flex';
            renderExistingUsersList();
        }

        function closeUserManagementModal() {
            document.getElementById('user-management-modal').style.display = 'none';
            showRoleSelection(); // Reopen role selection
        }

        async function renderExistingUsersList() {
            const users = await fetchData('/users');
            const listDiv = document.getElementById('existing-users-list');
            listDiv.innerHTML = '';

            if (!users || users.length === 0) {
                listDiv.innerHTML = '<p class="text-center text-gray-500">No users found.</p>';
                return;
            }

            users.forEach(user => {
                // System-critical users (1-4) or users with claims cannot be deleted in this proto
                const isSystemUser = user.userId <= 4; 
                
                const deleteButton = isSystemUser 
                    ? `<span class="text-red-400 text-sm">Cannot Delete (System User)</span>`
                    : `<button onclick="deleteUser(${user.userId})" class="text-red-600 hover:text-red-800 font-semibold">Delete</button>`;

                listDiv.innerHTML += `
                    <div class="flex justify-between items-center p-2 border-b">
                        <span>${user.employeeName} (${user.role})</span>
                        ${deleteButton}
                    </div>
                `;
            });
        }

        async function createUser() {
            const employeeName = document.getElementById('new-user-name').value.trim();
            const role = document.getElementById('new-user-role').value;

            if (!employeeName) {
                alert("Please enter a name for the new user.");
                return;
            }

            const payload = { employeeName, role };

            const result = await fetchData(`/users`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (result && result.userId) {
                alert(`User ${result.employeeName} created successfully!`);
                document.getElementById('new-user-name').value = '';
                renderExistingUsersList(); // Refresh list
            } else if (result && result.message) {
                alert(`Error: ${result.message}`);
            }
        }

        async function deleteUser(userId) {
            if (!confirm("Are you sure you want to delete this user? This cannot be undone.")) {
                return;
            }

            const result = await fetchData(`/users/${userId}`, {
                method: 'DELETE'
            });

            if (result && result.message && result.message.includes('Cannot delete user')) {
                 alert(`Error: ${result.message}`); // Shows if user has existing claims
            } else if (result && result.userId) {
                alert(`User ID ${result.userId} deleted successfully.`);
                if (currentUser && currentUser.userId === result.userId) {
                    currentUser = null;
                    updateUserInfo();
                    renderView(null); // Clear main view
                }
                renderExistingUsersList(); // Refresh list
            }
        }


        // --- HELPER MODAL FUNCTIONS (EXISTING) ---
        function showClaimModal() {
            document.getElementById('claim-modal').style.display = 'flex';
        }
        function closeClaimModal() {
            document.getElementById('claim-modal').style.display = 'none';
        }

        function getStatusClass(status) {
            switch (status) {
                case 'Approved': return 'bg-green-100 text-green-800';
                case 'Rejected': return 'bg-red-100 text-red-800';
                case 'Pending':
                default: return 'bg-yellow-100 text-yellow-800';
            }
        }
    </script>

</body>
</html>
