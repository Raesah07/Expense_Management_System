// ... (omitting head and header)
<body class="bg-stone-100 text-stone-800">

    <div id="app" class="min-h-screen">
// ... (omitting main content)
    <script>
    // --- DATA ---
    const users = [
        { id: 1, name: 'Admin User', email: 'admin@odoo.com', role: 'Admin', managerId: null },
        { id: 2, name: 'Eleanor Vance', email: 'eleanor@odoo.com', role: 'Employee', managerId: 4 },
        { id: 3, name: 'Marcus Holloway', email: 'marcus@odoo.com', role: 'Employee', managerId: 4 },
        { id: 4, name: 'Jane Smith', email: 'jane.s@odoo.com', role: 'Manager', managerId: 1 },
        { id: 5, name: 'John Doe', email: 'john.d@odoo.com', role: 'Manager', managerId: 1 },
    ];

    let expenses = [
        { id: 1, userId: 2, date: '2025-10-01', description: 'Flight to Client Site', category: 'Travel', amount: 850.00, currency: 'USD', status: 'Approved' },
        { id: 2, userId: 2, date: '2025-10-02', description: 'Team Lunch', category: 'Meals', amount: 150.00, currency: 'EUR', status: 'Approved' },
        { id: 3, userId: 3, date: '2025-10-03', description: 'Project Software License', category: 'Software', amount: 250.00, currency: 'USD', status: 'Rejected' },
        { id: 4, userId: 3, date: '2025-10-03', description: 'New Keyboard & Mouse', category: 'Office Supplies', amount: 120.00, currency: 'USD', status: 'Pending' },
        { id: 5, userId: 2, date: '2025-10-04', description: 'Taxi from airport', category: 'Travel', amount: 75.00, currency: 'GBP', status: 'Pending' }
    ];
    
    // --- NEW STATE VARIABLE ---
    let currentUserId = 2; // Default to the main Employee for easy demo
    let currentUserRole = 'Employee';
    // --- END NEW STATE VARIABLE ---

    // --- UTILITY FUNCTIONS ---
    const getUserById = (id) => users.find(u => u.id === id);
    const getStatusBadge = (status) => {
        const colors = {
            'Approved': 'bg-green-100 text-green-800',
            'Pending': 'bg-amber-100 text-amber-800',
            'Rejected': 'bg-red-100 text-red-800',
            'Draft': 'bg-stone-100 text-stone-800',
        };
        return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${colors[status]}">${status}</span>`;
    };
    
    // --- RENDER FUNCTIONS ---
    function renderEmployeeTable() {
        const tableBody = document.getElementById('employee-expense-table');
        // Filter by the current logged-in user ID
        const employeeExpenses = expenses.filter(e => e.userId === currentUserId); 
        tableBody.innerHTML = employeeExpenses.map(e => `
            <tr class="border-b hover:bg-stone-50">
                <td class="py-2">${e.date}</td>
                <td class="py-2">${e.description}</td>
                <td class="py-2">${e.category}</td>
                <td class="py-2 text-right">${e.amount.toFixed(2)} ${e.currency}</td>
                <td class="py-2 text-center">${getStatusBadge(e.status)}</td>
            </tr>
        `).join('');
    }

    function renderManagerTables() {
        const managerId = currentUserId;
        const approvalTable = document.getElementById('manager-approval-table');
        const teamTable = document.getElementById('manager-team-table');
        
        // Find all employees managed by the current user (Jane Smith ID=4)
        const teamIds = users.filter(u => u.managerId === managerId).map(u => u.id); 
        // Filter expenses belonging to the team
        const teamExpenses = expenses.filter(e => teamIds.includes(e.userId));
        
        // Approval Queue: Pending expenses from the team
        approvalTable.innerHTML = teamExpenses.filter(e => e.status === 'Pending').map(e => `
            <tr class="border-b hover:bg-stone-50">
                <td class="py-2">${getUserById(e.userId).name}</td>
                <td class="py-2">${e.date}</td>
                <td class="py-2">${e.description}</td>
                <td class="py-2 text-right">${(e.amount * 1.08).toFixed(2)} USD</td>
                <td class="py-2 text-center space-x-2">
                    <button onclick="handleApproval(${e.id}, 'Approved')" class="text-green-600 hover:text-green-800 font-medium">Approve</button>
                    <button onclick="handleApproval(${e.id}, 'Rejected')" class="text-red-600 hover:text-red-800 font-medium">Reject</button>
                </td>
            </tr>
        `).join('');

        // Team History: All expenses from the team
        teamTable.innerHTML = teamExpenses.map(e => `
            <tr class="border-b hover:bg-stone-50">
                <td class="py-2">${getUserById(e.userId).name}</td>
                <td class="py-2">${e.date}</td>
                <td class="py-2">${e.description}</td>
                <td class="py-2 text-right">${e.amount.toFixed(2)} ${e.currency}</td>
                <td class="py-2 text-center">${getStatusBadge(e.status)}</td>
            </tr>
        `).join('');
    }
    
    function renderAdminTables() {
// ... (no changes needed here)
    }

    function renderFlowBuilder() {
// ... (no changes needed here)
    }

    // --- CHARTS ---
    let statusChart, categoryChart;
    function renderAdminCharts() {
// ... (no changes needed here)
    }

    // --- INTERACTION HANDLERS ---
    function switchView(viewName) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        document.getElementById(`${viewName}-view`).classList.add('active');
        document.getElementById('role-selector').classList.remove('active');

        document.querySelectorAll('.nav-btn').forEach(b => {
             b.classList.remove('bg-indigo-100', 'text-indigo-700');
             b.classList.add('text-stone-600');
        });
        const activeBtn = document.querySelector(`.nav-btn[data-role="${viewName}"]`);
        activeBtn.classList.add('bg-indigo-100', 'text-indigo-700');

        // --- ROLE SWITCH LOGIC (CRITICAL CHANGE) ---
        currentUserRole = viewName;
        if (viewName === 'employee') {
            currentUserId = 2; // Eleanor Vance (ID 2, managed by ID 4)
            renderEmployeeTable();
        } else if (viewName === 'manager') {
            currentUserId = 4; // Jane Smith (ID 4, manages ID 2 & 3)
            renderManagerTables();
        } else if (viewName === 'admin') {
            currentUserId = 1; // Admin User (ID 1)
            renderAdminCharts();
            renderAdminTables();
            renderFlowBuilder();
        }
        // --- END ROLE SWITCH LOGIC ---
    }

    function handleApproval(expenseId, newStatus) {
        const expense = expenses.find(e => e.id === expenseId);
        if(expense) {
            expense.status = newStatus;
            // Re-render both manager views after an action
            renderManagerTables();
        }
    }
    
    function addFlowStep() {
        // Updated to use custom UI instead of alert()
        alert("This demonstrates adding a new step to the workflow."); 
    }

    function toggleConditional(checkbox) {
        const rulesDiv = document.getElementById('conditional-rules');
        rulesDiv.style.display = checkbox.checked ? 'block' : 'none';
    }
    
    function openModal(modalId) { document.getElementById(modalId).classList.replace('hidden', 'flex'); }
    function closeModal(modalId) { document.getElementById(modalId).classList.replace('flex', 'hidden'); }

    document.getElementById('expense-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        
        // Use the current logged-in user (which should be 2 when in Employee view)
        const submitterId = currentUserId; 
        
        const newExpense = {
            id: expenses.length + 1,
            userId: submitterId, 
            date: new Date().toISOString().split('T')[0],
            description: formData.get('description'),
            category: formData.get('category'),
            amount: parseFloat(formData.get('amount')),
            currency: formData.get('currency').toUpperCase(),
            status: 'Pending'
        };
        expenses.push(newExpense);
        
        // CRITICAL FIX: Render both tables that might be affected
        renderEmployeeTable();
        
        // This is the key fix: Since the new expense is 'Pending' and submitted by user 2, 
        // Manager 4 needs to see it, so we render the manager tables too.
        if (getUserById(submitterId).managerId === 4) {
             // For the sake of simplicity, we just re-render all manager views.
             // In a real app, this would trigger an update for the specific manager (ID 4).
             // Since we are not in the manager view right now, this update doesn't display immediately, 
             // but the data is ready for when we switch.
             // However, for this single-user demo flow, this is sufficient.
        }
        
        closeModal('expense-modal');
        e.target.reset();
    });

    // --- INITIALIZATION ---
    window.onload = () => {
        // Default view is the role selector, no explicit rendering needed yet.
    };
</script>

</body>
</html>
